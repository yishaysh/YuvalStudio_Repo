import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Calendar, Clock, Check, Loader2, ArrowRight, ArrowLeft, AlertCircle, Sparkles } from 'lucide-react';
import { Service, BookingStep, StudioSettings } from '../types';
import { api, TimeSlot } from '../services/mockApi';
import { DEFAULT_STUDIO_DETAILS, DEFAULT_WORKING_HOURS } from '../constants';
import { Button, Card, Input } from '../components/ui';

// --- Interactive Anatomy Map Component ---

interface AnatomyPoint {
  id: string;
  x: number;
  y: number;
  label: string;
  keyword: string; 
  type: 'stud' | 'ring' | 'barbell' | 'curved' | 'industrial' | 'septum'; 
}

// Updated coordinates for the Specific Ear SVG (m5488 2420)
const earPoints: AnatomyPoint[] = [
    { id: 'industrial', x: 60, y: 30, label: 'אינדסטריאל', keyword: 'אינדסטריאל', type: 'industrial' }, 
    { id: 'helix-upper', x: 75, y: 25, label: 'הליקס', keyword: 'הליקס', type: 'ring' },
    { id: 'forward-helix', x: 30, y: 35, label: 'פורוורד הליקס', keyword: 'פורוורד', type: 'stud' },
    { id: 'rook', x: 45, y: 38, label: 'רוק', keyword: 'רוק', type: 'curved' },
    { id: 'daith', x: 38, y: 48, label: 'דיית׳', keyword: 'דיית', type: 'ring' },
    { id: 'tragus', x: 28, y: 52, label: 'טראגוס', keyword: 'טראגוס', type: 'stud' },
    { id: 'snug', x: 78, y: 55, label: 'סנאג', keyword: 'סנאג', type: 'curved' },
    { id: 'conch', x: 55, y: 50, label: 'קונץ׳', keyword: 'קונץ', type: 'ring' },
    { id: 'anti-tragus', x: 65, y: 70, label: 'אנטי-טראגוס', keyword: 'אנטי', type: 'stud' },
    { id: 'lobe-upper', x: 60, y: 80, label: 'תנוך עליון', keyword: 'תנוך', type: 'stud' },
    { id: 'lobe-main', x: 50, y: 88, label: 'תנוך', keyword: 'תנוך', type: 'stud' },
];

// Updated coordinates for the Specific Face SVG (m2580 3323)
const facePoints: AnatomyPoint[] = [
    { id: 'eyebrow', x: 30, y: 38, label: 'גבה', keyword: 'גבה', type: 'curved' },
    { id: 'bridge', x: 50, y: 38, label: 'ברידג׳', keyword: 'ברידג', type: 'barbell' },
    { id: 'nostril', x: 42, y: 58, label: 'נזם', keyword: 'נזם', type: 'stud' },
    { id: 'septum', x: 50, y: 63, label: 'ספטום', keyword: 'ספטום', type: 'septum' },
    { id: 'philtrum', x: 50, y: 68, label: 'מדוזה', keyword: 'מדוזה', type: 'stud' },
    { id: 'monroe', x: 38, y: 66, label: 'מונרו', keyword: 'מונרו', type: 'stud' },
    { id: 'labret-side', x: 38, y: 78, label: 'סייד ליפ', keyword: 'שפה', type: 'ring' },
    { id: 'labret-center', x: 50, y: 78, label: 'לאברט', keyword: 'לאברט', type: 'stud' },
    { id: 'vertical-labret', x: 50, y: 75, label: 'ורטיקל', keyword: 'ורטיקל', type: 'curved' },
];

const AnatomyMap = ({ services, onSelect, selectedService }: { services: Service[], onSelect: (s: Service | null) => void, selectedService: Service | null }) => {
  const [view, setView] = useState<'ear' | 'face'>('ear');
  const [hoverMessage, setHoverMessage] = useState<{ x: number, y: number, text: string } | null>(null);
  const [visualSelectionId, setVisualSelectionId] = useState<string | null>(null);

  useEffect(() => {
      if (selectedService) {
          const point = [...earPoints, ...facePoints].find(p => selectedService.name.includes(p.keyword));
          if (point) setVisualSelectionId(point.id);
      }
  }, [selectedService]);

  const findService = (keyword: string) => services.find(s => s.name.includes(keyword) || s.category.includes(keyword));

  const handlePointClick = (point: AnatomyPoint) => {
    setVisualSelectionId(point.id);
    const service = findService(point.keyword);
    if (service) {
      onSelect(service);
      setHoverMessage(null);
    } else {
      onSelect(null);
      setHoverMessage({ x: point.x, y: point.y, text: 'שירות זה אינו זמין כרגע' });
      setTimeout(() => setHoverMessage(null), 3000);
    }
  };

  const currentPoints = view === 'ear' ? earPoints : facePoints;

  const JewelryRenderer = ({ point, isSelected }: { point: AnatomyPoint, isSelected: boolean }) => {
     if (!isSelected) {
         return <circle cx={0} cy={0} r="1.5" className="fill-white/30 group-hover:fill-white/80 transition-colors" />;
     }

     const colorPrimary = "#d4b585"; 
     const colorHighlight = "#fffbeb"; 
     const glowFilter = "url(#jewelryGlow)";

     switch(point.type) {
         case 'industrial':
             return (
                 <g filter={glowFilter}>
                     <motion.line 
                        x1="20" y1="-5" x2="-25" y2="10" 
                        stroke={colorPrimary} 
                        strokeWidth="1.5" 
                        strokeLinecap="round"
                        initial={{ pathLength: 0 }}
                        animate={{ pathLength: 1 }}
                        transition={{ duration: 0.5 }}
                     />
                     <circle cx="20" cy="-5" r="2" fill={colorHighlight} />
                     <circle cx="-25" cy="10" r="2" fill={colorHighlight} />
                 </g>
             );
         case 'septum':
             return (
                 <g filter={glowFilter}>
                     <motion.path 
                        d="M -4 -2 Q 0 5 4 -2" 
                        fill="none" 
                        stroke={colorPrimary} 
                        strokeWidth="1.2" 
                        strokeLinecap="round"
                        initial={{ opacity: 0, pathLength: 0 }}
                        animate={{ opacity: 1, pathLength: 1 }}
                     />
                     <circle cx="-4" cy="-2" r="1" fill={colorHighlight} />
                     <circle cx="4" cy="-2" r="1" fill={colorHighlight} />
                 </g>
             );
         case 'ring':
             return (
                 <g filter={glowFilter}>
                     <motion.circle 
                        r="3.5" 
                        fill="none" 
                        stroke={colorPrimary} 
                        strokeWidth="1" 
                        strokeDasharray="16 6" 
                        initial={{ rotate: 0, scale: 0 }}
                        animate={{ rotate: 360, scale: 1 }}
                        transition={{ type: "spring", stiffness: 200, damping: 20 }}
                     />
                     <circle cx="0" cy="3.5" r="1.2" fill={colorHighlight} />
                 </g>
             );
         case 'barbell': 
             return (
                 <g filter={glowFilter} transform="rotate(0)">
                     <line x1="-5" y1="0" x2="5" y2="0" stroke={colorPrimary} strokeWidth="1" />
                     <circle cx="-5" cy="0" r="1.5" fill={colorHighlight} />
                     <circle cx="5" cy="0" r="1.5" fill={colorHighlight} />
                 </g>
             );
         case 'curved': 
             return (
                 <g filter={glowFilter}>
                     <motion.path 
                        d="M -3 -3 Q 0 0 3 3" 
                        fill="none" 
                        stroke={colorPrimary} 
                        strokeWidth="1.2" 
                        strokeLinecap="round"
                        initial={{ pathLength: 0 }}
                        animate={{ pathLength: 1 }}
                     />
                     <circle cx="-3" cy="-3" r="1.5" fill={colorHighlight} />
                     <circle cx="3" cy="3" r="1.5" fill={colorHighlight} />
                 </g>
             );
         case 'stud': 
         default:
             return (
                 <g filter={glowFilter}>
                    <motion.path 
                       d="M 0 -2.5 L 2 0 L 0 2.5 L -2 0 Z" 
                       fill={colorHighlight} 
                       initial={{ scale: 0 }}
                       animate={{ scale: [1, 1.2, 1] }}
                       transition={{ repeat: Infinity, duration: 2, repeatDelay: 1 }}
                    />
                    <motion.g 
                       initial={{ opacity: 0 }} 
                       animate={{ opacity: [0, 1, 0] }}
                       transition={{ repeat: Infinity, duration: 2 }}
                    >
                       <line x1="0" y1="-4" x2="0" y2="4" stroke="white" strokeWidth="0.5" />
                       <line x1="-4" y1="0" x2="4" y2="0" stroke="white" strokeWidth="0.5" />
                    </motion.g>
                 </g>
             );
     }
  };

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-center min-h-[500px]">
      <div className="relative order-2 md:order-1 flex flex-col items-center">
        <div className="flex gap-4 mb-8 bg-brand-surface p-1 rounded-full border border-white/5">
          <button 
            onClick={() => setView('ear')}
            className={`px-6 py-2 rounded-full text-sm font-medium transition-all ${view === 'ear' ? 'bg-brand-primary text-brand-dark' : 'text-slate-400 hover:text-white'}`}
          >
            אוזן
          </button>
          <button 
             onClick={() => setView('face')}
             className={`px-6 py-2 rounded-full text-sm font-medium transition-all ${view === 'face' ? 'bg-brand-primary text-brand-dark' : 'text-slate-400 hover:text-white'}`}
          >
            פנים
          </button>
        </div>

        <div className="relative w-[300px] h-[400px] md:w-[400px] md:h-[500px] select-none">
           <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-2xl overflow-visible">
             <defs>
               <linearGradient id="goldGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                 <stop offset="0%" stopColor="#d4b585" stopOpacity="0.8" />
                 <stop offset="100%" stopColor="#c19f6e" stopOpacity="0.4" />
               </linearGradient>
               <filter id="jewelryGlow" x="-50%" y="-50%" width="200%" height="200%">
                 <feGaussianBlur in="SourceGraphic" stdDeviation="0.5" result="blur" />
                 <feColorMatrix in="blur" type="matrix" values="
                    0 0 0 0 1
                    0 0 0 0 0.9
                    0 0 0 0 0.5
                    0 0 0 0.6 0" result="coloredBlur"/>
                 <feMerge>
                    <feMergeNode in="coloredBlur" />
                    <feMergeNode in="SourceGraphic" />
                 </feMerge>
               </filter>
             </defs>

             {/* SVG Container Group with Scale Adjustment */}
             <motion.g
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                transition={{ duration: 1.5 }}
                transform="scale(0.09765625, 0.09765625)"
             >
                 {view === 'ear' ? (
                   // SVG: The Ear (Starts with m5488 2420...)
                   <g transform="translate(0, 1024) scale(0.1, -0.1)" fill="url(#goldGradient)" stroke="none">
                      <path d="M0 5120 l0 -5120 5120 0 5120 0 0 5120 0 5120 -5120 0 -5120 0 0 -5120z m5488 2420 c382 -64 748 -353 888 -704 39 -97 68 -202 60 -222 -14 -37 -34 -10 -61 84 -56 191 -156 354 -300 491 -220 209 -503 321 -810 321 -266 0 -497 -78 -712 -239 -307 -231 -561 -609 -653 -976 -93 -366 -60 -753 127 -1490 82 -326 125 -453 213 -630 97 -196 188 -313 440 -564 210 -209 250 -259 333 -412 120 -223 281 -365 492 -436 72 -25 94 -27 225 -27 134 0 150 2 215 27 185 73 294 200 345 401 11 44 20 95 20 115 0 74 11 111 33 111 19 0 20 -4 14 -92 -8 -116 -37 -232 -78 -308 -68 -127 -191 -230 -336 -278 -68 -22 -95 -26 -213 -26 -158 -1 -215 12 -355 80 -105 51 -203 127 -277 218 -51 62 -66 85 -173 273 -43 76 -83 122 -290 333 -418 427 -501 581 -665 1241 -102 409 -141 629 -162 898 -31 408 62 776 279 1106 275 416 631 667 1013 715 87 10 296 5 388 -10z m80 -434 c87 -22 195 -74 267 -128 131 -100 204 -234 242 -442 24 -135 22 -406 -5 -556 -38 -212 -122 -449 -210 -598 -45 -76 -142 -182 -166 -182 -32 0 -28 29 9 61 114 101 225 330 294 609 38 154 51 260 51 408 0 229 -44 414 -126 535 -58 85 -132 146 -238 197 -127 61 -201 72 -482 68 l-239 -3 -69 -32 c-225 -107 -430 -378 -540 -714 -45 -139 -122 -444 -135 -542 -48 -345 52 -914 219 -1248 95 -188 265 -392 434 -519 47 -36 86 -71 86 -78 0 -32 -34 -21 -106 33 -258 194 -447 457 -553 770 -114 337 -167 782 -126 1058 33 216 146 610 217 752 145 289 366 510 563 562 73 19 526 11 613 -11z m-340 -1006 c30 -53 109 -114 174 -136 112 -37 269 -14 422 62 53 27 71 32 82 23 23 -19 17 -27 -43 -58 -139 -69 -199 -85 -328 -85 -111 -1 -124 1 -180 27 -90 42 -196 154 -181 192 10 26 30 16 54 -25z m660 -201 c-2 -17 -24 -29 -108 -59 -150 -53 -200 -74 -324 -136 -299 -149 -465 -292 -565 -484 -129 -248 -100 -492 80 -670 106 -106 214 -149 422 -170 194 -19 266 -65 387 -244 37 -56 82 -116 101 -134 59 -57 142 -65 209 -19 59 40 75 70 78 155 4 85 8 75 -113 296 -43 80 -49 97 -53 165 -3 64 1 91 28 176 17 55 34 130 37 166 5 58 2 74 -21 125 -37 80 -30 103 56 187 38 37 76 67 83 67 34 0 22 -26 -44 -95 -39 -41 -71 -82 -71 -90 0 -9 10 -35 21 -58 32 -63 29 -159 -11 -300 -50 -175 -45 -218 48 -376 72 -123 92 -178 92 -250 0 -146 -89 -244 -220 -244 -99 0 -152 41 -258 198 -118 177 -166 206 -372 229 -199 23 -287 55 -404 152 -210 174 -263 471 -129 738 137 275 420 478 913 657 124 45 143 47 138 18z m3821 -5165 c27 -63 90 -123 156 -151 25 -10 45 -20 45 -23 0 -3 -25 -16 -56 -29 -63 -27 -123 -90 -151 -156 -10 -25 -20 -45 -23 -45 -3 0 -16 25 -29 56 -27 63 -90 123 -156 151 -25 10 -45 20 -45 23 0 3 25 16 56 29 63 27 123 90 151 156 10 25 20 45 23 45 3 0 16 -25 29 -56z"/>
                   </g>
                 ) : (
                   // SVG: The Face (Starts with m2580 3323...)
                   <g transform="translate(0, 1024) scale(0.1, -0.1)" fill="url(#goldGradient)" stroke="none">
                      <path d="M0 5120 l0 -5120 5120 0 5120 0 0 5120 0 5120 -5120 0 -5120 0 0 -5120z m2580 3323 c-177 -29 -335 -76 -457 -136 -72 -35 -161 -96 -123 -83 8 2 84 28 168 56 235 78 317 83 646 39 153 -21 275 -53 359 -96 62 -31 154 -90 162 -104 4 -6 -10 1 -32 14 -71 45 -197 104 -268 127 -62 19 -226 52 -232 46 -2 -1 48 -19 110 -40 187 -62 306 -137 518 -329 97 -88 38 -50 -76 49 -177 153 -291 217 -545 304 -71 25 -197 40 -331 40 -109 0 -235 -27 -311 -66 -17 -9 -71 -28 -122 -43 -144 -45 -241 -94 -371 -193 -66 -50 -109 -78 -95 -63 14 15 61 55 104 88 43 33 114 92 157 131 126 114 312 220 420 240 23 4 17 0 -21 -14 -132 -49 -324 -165 -396 -242 l-29 -30 70 38 c39 21 92 56 120 77 61 48 161 99 257 131 93 32 251 65 303 64 24 0 30 -2 15 -5z m5217 -13 c114 -24 225 -61 306 -101 77 -39 197 -119 197 -131 0 -5 5 -6 10 -3 6 4 33 -7 60 -24 67 -41 70 -39 14 9 -75 66 -189 139 -298 191 -113 54 -118 61 -20 24 92 -35 208 -106 295 -181 91 -78 145 -123 238 -194 39 -30 71 -58 71 -63 0 -4 -37 21 -82 56 -46 36 -105 78 -133 94 -55 32 -232 106 -280 118 -16 3 -64 19 -105 35 -41 16 -110 39 -153 52 -43 12 -73 24 -68 26 12 4 112 -25 279 -80 68 -22 125 -38 128 -36 6 7 -136 86 -214 119 -77 32 -228 74 -337 94 -48 9 -59 13 -35 14 19 0 76 -8 127 -19z m-4814 -35 c208 -36 491 -174 644 -313 75 -68 278 -312 260 -312 -3 0 -48 52 -101 115 -53 63 -122 140 -154 170 -175 171 -491 312 -767 343 -77 9 -78 9 -24 11 31 0 95 -6 142 -14z m4437 8 c-194 -19 -327 -57 -509 -144 -197 -94 -281 -162 -443 -356 -61 -73 -112 -133 -115 -133 -22 0 184 246 268 320 104 92 166 131 319 201 180 82 318 118 450 116 36 0 49 -2 30 -4z m-4140 -40 c135 -44 243 -108 353 -208 122 -110 197 -190 275 -293 112 -148 98 -138 -50 38 -129 154 -178 199 -293 276 -128 86 -177 113 -264 145 -42 15 -71 28 -65 29 22 1 127 -41 201 -79 42 -22 79 -39 81 -36 8 8 -185 98 -282 131 -56 19 -85 32 -66 28 19 -3 69 -17 110 -31z m-320 -2 c129 -23 195 -43 290 -91 161 -80 321 -212 501 -412 123 -136 61 -85 -111 91 -112 115 -189 184 -238 216 -168 108 -307 160 -509 190 -118 18 -397 25 -478 11 -27 -4 -47 -5 -44 -2 30 31 408 29 589 -3z m4127 23 c-3 -3 -12 -4 -19 -1 -8 3 -5 6 6 6 11 1 17 -2 13 -5z m763 -13 c26 -7 14 -8 -45 -3 -131 11 -363 6 -465 -11 -312 -52 -485 -149 -747 -416 -89 -91 -164 -163 -168 -160 -3 4 70 83 162 176 282 285 441 371 773 419 105 15 429 12 490 -5z m-865 -15 c-85 -28 -210 -84 -203 -91 3 -3 28 6 57 20 55 28 157 65 175 65 6 -1 -24 -14 -67 -30 -165 -61 -346 -179 -463 -301 -81 -85 -189 -211 -204 -239 -6 -12 -14 -19 -18 -16 -3 4 4 20 16 36 24 32 28 45 11 35 -6 -4 -1 13 12 36 40 79 90 153 138 202 49 51 159 136 201 156 l25 12 -25 -18 c-86 -62 -180 -145 -224 -199 -56 -68 -122 -172 -114 -180 3 -2 38 35 78 83 130 156 324 320 447 379 84 41 176 73 208 73 11 0 -11 -10 -50 -23z m-3300 -64 c94 -66 165 -134 226 -216 57 -76 139 -229 154 -286 3 -14 -14 17 -39 68 -25 50 -68 126 -96 167 -65 93 -197 220 -297 286 -43 28 -80 53 -83 56 -13 14 90 -43 135 -75z m-131 29 c144 -80 260 -183 341 -305 51 -76 100 -174 92 -183 -2 -2 -23 32 -46 76 -89 164 -201 280 -386 396 -103 64 -103 72 -1 16z m3171 6 c-177 -95 -341 -260 -440 -439 -20 -38 -39 -68 -41 -68 -8 0 37 93 72 147 59 93 140 188 213 247 61 50 223 146 246 146 6 0 -17 -15 -50 -33z m-75 19 c0 -2 -25 -20 -56 -40 -77 -51 -215 -186 -270 -263 -25 -36 -70 -115 -100 -176 -30 -62 -52 -101 -49 -87 11 44 93 208 136 272 57 85 164 188 256 248 74 49 83 54 83 46z m1155 -6 c14 -6 -5 -9 -57 -9 -144 -2 -440 -39 -529 -67 -104 -33 -180 -66 -242 -106 -26 -17 -50 -28 -53 -26 -7 8 81 62 166 102 93 44 199 70 355 87 66 7 145 16 175 19 79 10 162 10 185 0z m-3857 -178 c86 -103 162 -253 177 -347 4 -27 -4 -14 -23 41 -49 138 -143 285 -242 378 -27 26 -50 49 -50 52 0 12 100 -79 138 -124z m3387 94 c-150 -54 -263 -119 -391 -224 -144 -118 -194 -156 -194 -149 0 11 226 200 295 247 94 63 163 98 265 131 117 39 135 35 25 -5z m248 9 c-142 -29 -232 -56 -341 -104 -104 -45 -249 -133 -315 -191 -26 -24 -50 -40 -53 -38 -7 8 103 100 176 148 149 96 308 158 494 191 145 25 172 21 39 -6z m-4775 -21 c133 -33 250 -82 362 -153 93 -58 205 -149 196 -158 -3 -3 -23 10 -44 29 -145 131 -384 244 -632 298 -71 15 -81 19 -40 15 30 -3 101 -17 158 -31z m3561 -21 c-134 -139 -215 -278 -259 -445 l-19 -73 0 71 c-2 147 67 320 167 423 l54 56 -40 -51 c-77 -95 -150 -254 -166 -359 -4 -30 1 -21 22 36 44 120 109 224 197 316 44 46 84 83 90 83 5 0 -16 -26 -46 -57z m-3900 37 c186 -17 427 -78 556 -143 74 -36 222 -137 255 -173 14 -14 -13 1 -60 35 -127 90 -260 156 -397 195 -205 59 -278 70 -480 70 -184 1 -218 6 -115 17 90 10 120 9 241 -1z m5573 -8 c4 -4 -54 -6 -130 -4 -170 5 -318 -18 -507 -79 -156 -50 -239 -90 -364 -176 -51 -35 -90 -60 -87 -54 15 23 167 129 241 168 126 65 359 131 535 153 82 10 300 4 312 -8z m-3963 -195 c51 -104 71 -185 70 -278 -1 -51 -3 -66 -9 -49 -4 14 -5 35 -3 47 17 77 -73 304 -167 423 l-51 65 60 -63 c38 -40 74 -92 100 -145z m-389 117 c79 -60 172 -162 219 -242 58 -96 51 -101 -10 -8 -65 98 -149 189 -245 262 -40 31 -74 59 -74 61 0 6 49 -27 110 -73z m2460 21 c-80 -116 -119 -244 -121 -400 l-2 -90 -10 67 c-19 133 27 300 114 415 49 65 62 70 19 8z m-1987 -100 c19 -38 39 -90 45 -115 17 -74 24 -182 14 -230 -9 -41 -10 -36 -11 51 -2 147 -38 264 -122 399 l-22 35 31 -35 c17 -19 47 -66 65 -105z m3597 110 c-189 -26 -343 -77 -563 -184 -138 -69 -122 -48 23 28 203 106 418 169 575 169 56 0 53 -1 -35 -13z m-5137 -11 c42 -8 112 -26 155 -40 84 -28 322 -142 362 -174 14 -11 -45 13 -130 54 -181 87 -300 129 -424 151 -113 19 -178 19 -87 -1 107 -23 202 -54 299 -96 51 -22 91 -42 89 -44 -1 -2 -50 15 -107 38 -58 22 -157 54 -220 71 -107 28 -127 31 -280 30 -117 0 -184 -5 -230 -16 -79 -20 -92 -14 -17 8 118 34 451 45 590 19z m5550 -8 c37 -7 71 -16 75 -21 4 -4 -4 -5 -18 -2 -239 55 -505 25 -779 -86 -61 -25 -111 -43 -111 -41 0 8 144 71 237 104 187 66 406 83 596 46z m-5667 -50 c65 -16 177 -56 172 -61 -2 -2 -50 10 -108 27 -104 31 -107 31 -345 32 -132 1 -260 -2 -285 -6 -33 -5 -38 -4 -20 2 81 30 469 34 586 6z m5774 5 c23 -11 23 -11 -10 -6 -200 32 -497 6 -695 -60 -16 -6 -17 -5 -5 4 21 15 161 60 224 71 73 13 455 6 486 -9z m-5855 -29 c19 -6 -23 -7 -115 -4 -196 6 -379 -11 -480 -44 -44 -15 -87 -32 -97 -39 -9 -7 23 1 71 17 65 22 113 30 180 33 l91 4 -75 -9 c-131 -16 -300 -67 -300 -91 0 -5 -27 -23 -61 -40 -34 -16 -59 -33 -56 -35 7 -7 63 21 102 51 28 21 132 55 215 69 58 11 19 -9 -55 -27 -75 -19 -154 -55 -249 -112 -64 -39 -75 -42 -56 -20 16 19 6 19 -28 -1 -21 -12 -20 -10 7 13 18 15 63 46 100 68 36 22 66 47 66 54 0 20 117 78 195 97 36 9 108 20 160 24 111 10 342 5 385 -8z m5785 8 c150 -16 286 -59 363 -115 l22 -17 -24 7 c-16 5 -21 4 -17 -4 8 -12 -23 -2 -74 24 -39 20 -146 44 -239 54 l-76 8 58 2 c74 1 193 -23 264 -55 66 -29 82 -31 33 -4 -62 35 -183 68 -290 81 -107 12 -406 8 -445 -7 -11 -4 -17 -3 -12 2 25 27 273 41 437 24z m-4702 -155 c72 -58 132 -110 132 -116 0 -10 -151 105 -225 171 -22 19 -56 48 -75 64 l-35 28 35 -20 c19 -12 95 -69 168 -127z m-2 68 c28 -24 84 -80 125 -125 90 -102 63 -80 -94 77 -121 121 -125 126 -31 48z m801 -99 c6 -94 -16 -226 -40 -241 -6 -4 -8 0 -4 9 27 71 34 288 13 378 -4 14 1 7 9 -15 9 -22 19 -81 22 -131z m1654 115 c-15 -64 -13 -226 3 -289 18 -70 14 -75 -10 -13 -23 60 -26 234 -5 306 17 59 25 56 12 -4z m834 19 c-22 -17 -86 -78 -143 -136 -57 -57 -105 -102 -108 -100 -8 9 156 177 217 222 68 51 97 63 34 14z m88 -1 c-78 -69 -284 -229 -289 -225 -6 6 79 79 210 180 104 80 144 103 79 45z m1568 -68 c133 -34 213 -69 269 -119 38 -34 27 -31 -36 12 -50 33 -143 78 -164 78 -8 0 19 -16 59 -35 79 -38 135 -74 127 -82 -3 -3 -17 4 -33 15 -63 44 -223 116 -308 137 -49 13 -78 24 -64 24 15 1 82 -13 150 -30z m-6869 -157 c-29 -15 -78 -49 -109 -76 -32 -28 -51 -40 -44 -28 6 12 31 38 56 59 24 20 42 39 40 41 -2 3 -13 -1 -22 -9 -16 -13 -17 -12 -4 4 8 10 20 16 27 13 8 -3 28 1 46 9 58 25 65 16 10 -13z m7084 13 c20 -8 40 -12 45 -9 5 3 21 -4 35 -15 32 -25 24 -27 -14 -4 -18 11 -15 5 10 -16 21 -17 47 -46 60 -64 18 -25 10 -21 -37 21 -33 29 -82 64 -110 77 -55 27 -46 34 11 10z m-5434 -518 c218 -57 394 -162 579 -346 64 -64 150 -161 191 -216 119 -160 118 -165 -4 -20 -268 320 -527 496 -816 555 -114 23 -323 27 -429 9 -61 -11 -63 -12 -57 -38 21 -91 103 -195 146 -187 13 3 25 5 27 5 3 1 -10 12 -29 26 -37 27 -84 95 -94 135 -4 16 1 12 15 -14 23 -42 112 -136 129 -136 6 0 -1 17 -14 38 -21 31 -51 122 -41 122 2 0 17 -29 33 -64 22 -47 39 -69 62 -81 18 -9 34 -15 36 -12 2 2 -7 28 -21 58 -14 30 -25 68 -24 84 0 26 3 23 19 -23 23 -65 53 -108 81 -115 16 -4 19 -2 14 11 -13 31 -18 132 -8 132 6 0 13 -25 15 -57 5 -61 30 -93 72 -93 19 0 21 6 22 58 1 32 5 66 11 75 6 12 8 -3 5 -46 -5 -80 3 -89 99 -107 l72 -14 39 43 c21 24 38 40 38 36 0 -9 -42 -69 -52 -73 -18 -8 -6 -20 24 -26 24 -5 41 0 72 20 l41 25 -33 -30 -33 -31 26 -10 c36 -14 43 -13 84 11 l36 20 -32 -27 -31 -28 104 -62 c122 -72 198 -129 384 -283 153 -127 170 -149 145 -188 -16 -23 -20 -24 -78 -19 -34 3 -116 8 -182 12 -119 6 -122 6 -335 -44 -118 -28 -250 -56 -293 -63 -85 -14 -87 -17 -61 -83 5 -13 4 -17 -4 -12 -6 4 -14 23 -18 43 l-7 36 -66 -7 c-36 -3 -78 -6 -92 -6 -24 0 -28 -6 -42 -57 -14 -56 -15 -56 -16 -20 -1 21 4 47 9 57 9 17 5 19 -37 24 -104 13 -249 49 -326 82 -101 43 -230 129 -305 201 l-57 55 68 -52 c224 -172 439 -250 692 -250 140 0 274 20 560 85 110 25 210 45 222 45 33 0 73 92 73 167 l0 59 -77 51 c-99 65 -208 124 -301 162 -39 16 -72 29 -72 28 0 -1 9 -31 20 -65 104 -332 -229 -623 -547 -478 -76 35 -164 127 -194 203 -32 82 -37 200 -11 276 l19 57 -21 -6 c-57 -18 -193 -88 -291 -151 -132 -84 -159 -98 -205 -108 -27 -5 -21 0 29 25 35 17 62 32 60 35 -3 2 -29 -4 -59 -14 -85 -28 -133 -33 -196 -22 -66 12 -171 60 -198 90 -13 14 0 10 46 -14 67 -36 113 -50 193 -59 l50 -6 -52 24 c-63 30 -70 41 -12 21 45 -16 146 -20 167 -6 9 5 -1 10 -31 13 -24 3 -66 16 -93 29 -51 26 -142 108 -164 149 -8 16 8 6 46 -30 100 -94 178 -131 276 -132 32 0 55 -4 52 -9 -3 -5 -15 -9 -27 -9 -21 -1 -21 -1 -3 -11 12 -7 21 -8 25 -1 16 25 239 153 335 191 168 67 221 75 451 75 183 -1 208 -3 288 -26 49 -14 90 -21 93 -16 7 11 8 10 -30 26 -21 10 -32 10 -42 1 -10 -8 -14 -8 -14 0 0 6 -12 11 -27 11 -19 0 -24 3 -15 8 8 6 -14 15 -59 26 -52 12 -74 14 -79 6 -5 -8 -11 -6 -19 4 -7 8 -25 15 -39 15 -15 -1 -53 1 -85 4 -31 3 -60 1 -63 -4 -3 -5 -21 -9 -40 -9 -24 0 -33 -4 -28 -12 5 -8 -7 -10 -44 -5 -29 3 -54 2 -57 -4 -4 -5 -26 -9 -51 -9 -29 0 -46 -5 -50 -14 -7 -17 -56 -36 -95 -36 -18 0 -30 -6 -34 -19 -10 -31 -28 -41 -109 -56 -73 -14 -80 -14 -138 6 -66 22 -92 37 -154 86 -23 18 -44 33 -49 33 -4 0 -25 -14 -47 -31 -36 -29 -38 -33 -23 -49 35 -38 135 -82 198 -87 l62 -4 -50 18 c-43 16 -145 77 -145 88 0 2 33 -13 73 -33 49 -24 90 -37 129 -40 57 -4 91 -23 68 -37 -6 -4 -43 -9 -83 -12 -89 -6 -163 18 -229 77 l-45 39 -28 -27 -29 -27 27 36 c20 29 23 39 14 50 -10 11 -9 11 3 2 12 -9 23 -4 53 23 l38 35 -22 37 -22 37 29 -33 29 -32 32 25 c31 25 31 26 16 56 -8 17 -13 32 -10 35 2 3 10 -9 17 -26 15 -36 16 -36 55 -9 17 11 69 40 118 65 76 39 87 48 88 72 2 25 2 25 6 3 4 -18 9 -22 26 -18 57 14 194 58 210 67 10 6 17 7 17 0 0 -5 6 -7 13 -5 40 16 151 23 282 20 119 -3 170 -9 247 -28z m4288 20 c19 -1 37 -5 40 -8 3 -4 48 -18 100 -32 52 -14 103 -29 112 -32 13 -5 20 -1 27 16 l10 24 0 -27 c1 -23 11 -32 80 -66 43 -22 96 -51 117 -66 l39 -26 17 22 c19 25 24 18 8 -12 -8 -15 -4 -23 23 -44 l32 -26 23 25 c26 30 29 25 6 -10 -15 -23 -14 -25 22 -57 42 -37 51 -46 77 -77 34 -41 16 -32 -51 28 -38 34 -72 61 -76 61 -4 0 -27 -16 -50 -34 -52 -43 -137 -83 -193 -92 -23 -3 -73 -1 -110 6 -53 9 -74 18 -93 39 -17 18 -41 30 -66 34 -23 4 -52 15 -65 26 -27 21 -82 33 -147 32 -24 0 -54 6 -65 13 -12 8 -34 15 -49 15 -16 1 -34 2 -40 2 -80 3 -149 -5 -159 -17 -9 -11 -14 -12 -19 -3 -6 9 -20 9 -61 -1 -94 -21 -93 -20 -77 -36 11 -12 28 -12 98 -3 49 7 148 9 240 6 128 -4 170 -9 243 -31 128 -38 261 -104 399 -197 68 -46 143 -91 168 -100 25 -10 37 -18 28 -19 -33 0 -114 36 -188 87 -110 73 -188 117 -281 157 -45 20 -84 36 -85 36 -2 0 4 -12 11 -27 23 -45 38 -133 32 -198 -8 -99 -42 -171 -111 -240 -70 -70 -128 -100 -218 -115 -290 -46 -535 242 -438 516 l19 56 -27 -7 c-46 -11 -222 -101 -327 -168 l-100 -63 3 -59 c2 -34 13 -81 26 -110 l22 -49 104 -21 c58 -12 197 -41 310 -65 196 -42 212 -44 380 -44 153 -1 187 2 269 23 119 30 340 140 436 217 l70 55 -64 -62 c-140 -135 -374 -246 -555 -265 -37 -4 -66 -8 -66 -9 0 -1 7 -19 15 -38 17 -41 20 -81 5 -72 -5 3 -10 17 -10 30 0 13 -5 36 -12 50 -10 22 -17 25 -62 25 -28 0 -81 3 -118 6 l-67 7 -6 -37 c-4 -20 -12 -39 -17 -42 -6 -4 -8 1 -5 12 18 66 18 74 -2 74 -29 0 -257 47 -415 86 -160 39 -256 43 -399 19 -92 -17 -117 -12 -136 23 -16 30 11 70 91 135 42 34 122 100 178 146 113 93 263 196 327 225 l41 18 -26 24 -27 24 39 -16 c32 -12 44 -13 68 -3 l29 12 -33 28 c-18 15 -28 28 -21 29 6 0 15 -5 18 -10 15 -24 64 -40 91 -30 l26 10 -26 34 c-36 48 -32 54 8 12 37 -40 44 -41 136 -18 l65 17 5 60 5 60 9 -52 c4 -29 4 -57 0 -64 -5 -9 3 -11 31 -6 43 7 52 17 61 67 3 19 10 44 15 55 11 23 5 -68 -6 -97 -5 -14 -2 -18 14 -18 23 0 65 64 86 133 8 23 14 33 14 22 1 -33 -20 -98 -41 -128 -23 -32 -19 -42 15 -33 27 6 68 63 97 134 10 26 19 42 19 35 1 -22 -39 -121 -60 -147 -13 -17 -16 -26 -8 -26 21 0 113 101 137 150 12 25 22 39 22 31 0 -27 -64 -132 -102 -166 -34 -32 -36 -35 -16 -35 52 0 123 76 152 164 9 27 15 50 14 52 -7 6 -67 15 -160 23 -336 28 -634 -80 -915 -331 -75 -66 -116 -109 -267 -279 -65 -73 -19 -8 85 121 249 309 489 458 839 524 22 4 289 -1 390 -7z m585 -392 c-27 -23 -73 -48 -130 -71 -18 -7 -16 -8 10 -12 39 -5 101 14 150 47 64 43 73 45 31 7 -59 -54 -113 -76 -182 -75 -63 0 -125 17 -131 35 -3 8 20 13 66 16 56 3 82 11 138 40 82 43 87 45 48 13z m224 -17 c-40 -75 -177 -168 -247 -168 -20 0 -31 -4 -27 -10 11 -17 122 -11 177 10 28 10 46 14 40 8 -6 -6 -35 -19 -64 -29 l-53 -18 46 -1 c53 0 160 30 217 61 l37 21 -25 -22 c-14 -13 -48 -34 -77 -47 -105 -49 -218 -48 -325 2 -58 27 -79 51 -34 39 33 -8 138 20 199 53 27 15 70 49 96 75 53 54 56 56 40 26z m-6189 -82 c30 -8 82 -18 115 -22 l60 -8 -39 -7 c-53 -9 -154 13 -216 47 -68 37 -88 64 -24 31 27 -14 74 -32 104 -41z m6095 44 c-12 -19 -105 -60 -170 -75 -51 -12 -75 -13 -105 -5 -48 13 -52 21 -7 13 37 -6 184 30 236 57 41 22 55 25 46 10z m-3285 -382 c15 -222 -9 -522 -55 -698 -8 -33 -12 -40 -9 -19 15 117 35 427 41 642 3 136 8 246 9 244 2 -2 8 -78 14 -169z m-2749 77 c-42 -19 -52 -19 -27 0 11 8 29 15 40 15 16 -1 12 -5 -13 -15z m5860 -5 l24 -21 -35 17 c-43 21 -47 24 -28 24 9 0 26 -9 39 -20z m-5791 -29 c0 -5 -13 -12 -30 -16 -17 -4 -45 -24 -65 -48 -37 -43 -44 -43 -21 2 16 30 49 55 81 64 32 8 35 8 35 -2z m5755 -5 c19 -8 44 -30 55 -48 31 -51 24 -52 -23 -3 -25 25 -53 45 -65 45 -11 0 -24 5 -27 10 -9 14 20 12 60 -4z m-5685 -31 c0 -3 -15 -11 -33 -19 -18 -7 -45 -28 -60 -45 -30 -36 -33 -35 -15 5 14 29 108 81 108 59z m5655 -47 c38 -46 30 -49 -15 -6 -23 21 -47 38 -55 38 -8 0 -15 4 -15 9 0 18 59 -10 85 -41z m-5631 -27 c-37 -17 -58 -37 -91 -87 -10 -16 -11 -14 -2 11 19 54 66 93 114 94 12 0 4 -7 -21 -18z m5556 -7 c28 -24 60 -72 60 -90 0 -4 -13 12 -30 34 -16 23 -47 50 -67 61 -30 16 -34 20 -16 21 12 0 35 -12 53 -26z m-5460 -11 c0 -5 -17 -16 -38 -25 -20 -10 -45 -30 -54 -45 -10 -15 -18 -23 -18 -16 0 17 50 74 74 83 27 11 36 12 36 3z m5398 -39 c45 -47 40 -60 -6 -15 -20 20 -46 42 -57 49 -19 12 -18 12 5 6 14 -3 40 -21 58 -40z m-5386 -10 c-31 -16 -63 -40 -78 -62 -21 -30 -24 -32 -19 -12 14 49 79 99 130 99 11 0 -3 -11 -33 -25z m5317 11 c35 -18 81 -71 81 -93 0 -10 -11 -1 -26 22 -17 25 -44 46 -78 61 -36 17 -45 24 -28 24 13 1 36 -6 51 -14z m-5199 -24 c0 -5 -9 -13 -21 -16 -11 -4 -34 -28 -51 -53 -19 -31 -28 -38 -23 -22 9 35 38 73 66 87 29 15 29 15 29 4z m5115 -23 c19 -18 37 -46 40 -63 6 -29 5 -28 -15 8 -12 21 -37 48 -56 59 -38 22 -42 28 -19 28 8 0 31 -15 50 -32z m-5094 -15 c-6 -10 -20 -29 -31 -43 l-21 -25 12 25 c11 25 39 60 46 60 2 0 -1 -8 -6 -17z m5059 -50 c0 -19 0 -19 -29 32 l-23 40 26 -28 c14 -15 26 -35 26 -44z m-4929 3 c-12 -18 -21 -41 -21 -50 0 -9 -5 -16 -10 -16 -16 0 0 52 23 78 29 31 32 27 8 -12z m378 -13 c-1 -39 -2 -43 -9 -23 -12 36 -12 70 0 70 6 0 10 -21 9 -47z m4012 -23 c-9 -24 -10 -24 -10 7 -1 17 2 40 7 50 6 15 7 14 10 -7 2 -14 -2 -37 -7 -50z m398 -8 c0 -16 -3 -21 -6 -12 -3 8 -14 33 -25 55 l-19 40 26 -28 c14 -16 25 -39 24 -55z m-4684 18 c-8 -27 -14 -36 -14 -23 -1 24 17 78 24 71 2 -2 -2 -24 -10 -48z m65 43 c0 -5 -7 -30 -14 -58 -14 -48 -14 -48 -15 -15 -1 43 8 80 20 80 5 0 9 -3 9 -7z m129 -40 c0 -40 -2 -44 -10 -25 -8 21 -3 72 7 72 2 0 4 -21 3 -47z m4171 0 c0 -55 -5 -54 -14 5 -4 26 -2 42 4 42 5 0 10 -21 10 -47z m86 23 c3 -13 4 -35 2 -47 -2 -17 -6 -11 -14 24 -6 26 -7 47 -3 47 5 0 11 -11 15 -24z m113 -46 c0 -22 -2 -21 -14 10 -18 47 -18 71 0 40 8 -14 14 -36 14 -50z m-3165 -1087 c-136 -189 -205 -421 -182 -610 19 -159 160 -290 326 -301 65 -4 126 12 119 32 -2 6 -21 16 -43 22 -110 32 -164 84 -164 158 0 76 92 150 201 163 138 16 355 -115 427 -259 23 -48 29 -102 11 -113 -6 -4 -10 -1 -8 6 5 37 -4 61 -43 114 -72 96 -224 196 -324 211 -98 14 -227 -57 -227 -126 0 -44 55 -93 130 -117 94 -30 107 -75 33 -113 -79 -40 -223 -15 -326 55 -162 112 -205 316 -122 575 24 76 68 167 111 230 28 40 125 150 133 150 2 0 -22 -35 -52 -77z m1864 -87 c99 -153 148 -321 140 -481 -6 -101 -32 -175 -87 -241 -115 -141 -369 -192 -437 -90 -15 24 -15 28 0 44 8 10 40 26 71 36 70 22 125 72 125 113 0 71 -86 127 -195 128 -62 0 -79 -5 -148 -39 -132 -66 -256 -198 -258 -277 l0 -24 -10 24 c-31 79 99 240 260 319 69 34 82 37 161 37 79 0 91 -3 136 -30 91 -57 118 -136 72 -205 -25 -37 -93 -76 -150 -85 -89 -16 -14 -61 86 -53 128 11 240 89 299 207 31 63 32 70 31 176 -1 77 -8 134 -23 190 -25 95 -95 245 -154 329 -62 89 -64 97 -11 41 26 -27 68 -81 92 -119z m-1120 -78 c61 -21 80 -38 44 -38 -11 0 -45 -9 -77 -20 -76 -26 -110 -26 -129 2 -26 37 10 76 74 77 14 1 53 -9 88 -21z m372 7 c17 -21 -9 -49 -66 -71 -93 -36 -131 18 -44 62 52 27 92 30 110 9z m-428 -980 c-11 -33 -32 -93 -46 -132 -28 -78 -33 -153 -13 -192 6 -13 47 -44 89 -69 66 -38 88 -45 145 -49 65 -5 72 -3 161 42 54 27 100 57 110 73 30 45 22 132 -22 242 -34 85 -63 206 -53 217 3 2 14 -24 25 -59 11 -35 36 -101 56 -148 40 -95 47 -173 21 -224 -9 -16 -14 -30 -13 -32 2 -1 29 5 61 13 49 14 67 14 127 4 230 -41 649 -355 1120 -837 98 -100 104 -108 42 -54 -40 35 -128 113 -195 173 -545 492 -900 715 -1074 677 -26 -6 -89 -33 -139 -60 -50 -27 -118 -57 -151 -66 -55 -15 -64 -15 -122 0 -35 9 -90 32 -121 51 -97 59 -140 75 -206 75 -192 0 -494 -201 -1046 -697 -122 -109 -226 -200 -232 -202 -17 -5 110 122 301 304 506 481 859 692 1056 632 41 -13 64 -9 38 7 -16 10 -22 79 -12 133 6 28 29 94 51 147 23 53 44 113 48 134 l7 37 3 -40 c2 -22 -6 -67 -16 -100z m-7 -895 c5 -13 4 -13 -8 0 -23 25 -37 79 -36 144 l1 61 19 -95 c10 -52 21 -101 24 -110z m481 46 c-4 -17 -16 -42 -27 -56 -17 -20 -19 -21 -13 -5 4 11 14 47 23 79 16 60 29 47 17 -18z m365 17 c-17 -29 -44 -57 -78 -81 -53 -37 -58 -24 -6 17 26 21 57 48 67 60 23 26 30 27 17 4z m353 -154 c-24 -27 -78 -54 -124 -64 -25 -5 -12 6 50 38 47 24 87 45 89 46 2 0 -4 -8 -15 -20z m-1957 -56 c46 -23 47 -24 13 -18 -36 6 -100 51 -108 76 -3 8 6 4 21 -10 14 -13 47 -34 74 -48z m893 41 c105 -4 216 -2 305 6 233 21 370 -8 757 -161 125 -49 262 -99 305 -110 91 -25 286 -36 353 -21 39 9 43 9 26 -3 -56 -42 -287 -45 -426 -5 -41 12 -165 57 -275 100 -359 140 -465 165 -658 156 -349 -17 -440 -18 -518 -6 -110 16 -260 14 -350 -5 -100 -21 -226 -63 -468 -157 -112 -44 -238 -88 -280 -99 -100 -27 -246 -29 -323 -6 -80 24 -80 36 0 19 55 -11 85 -12 164 -2 127 15 213 41 438 132 102 42 235 92 295 111 96 31 141 42 255 61 14 2 72 2 130 0 58 -2 179 -7 270 -10z m-290 -230 c239 -40 454 -40 715 0 239 37 470 42 605 12 46 -10 93 -22 105 -27 17 -8 17 -9 -5 -4 -169 35 -390 30 -659 -15 -360 -60 -469 -60 -821 1 -205 36 -429 48 -559 30 -46 -6 -86 -9 -88 -7 -5 4 78 23 162 37 97 15 369 2 545 -27z m-855 -141 c-42 -65 -45 -69 -45 -51 0 16 46 78 57 78 3 0 -3 -12 -12 -27z m219 -34 c-20 -28 -48 -76 -61 -107 -22 -52 -24 -54 -19 -20 7 51 31 100 72 142 49 50 52 45 8 -15z m2009 -47 c15 -28 30 -72 33 -98 l5 -49 -18 50 c-21 59 -65 136 -87 155 -28 22 -17 32 12 11 15 -11 40 -42 55 -69z m-1829 21 c-19 -32 -46 -92 -59 -133 -18 -56 -24 -67 -25 -44 0 50 26 124 66 181 49 71 61 68 18 -4z m-606 -154 c305 -254 621 -392 1017 -444 177 -23 605 -24 799 0 432 51 790 220 1110 525 114 108 80 56 -42 -66 -230 -229 -538 -396 -863 -468 -191 -42 -301 -51 -619 -51 -231 1 -320 4 -410 18 -364 57 -646 176 -911 388 -85 67 -259 242 -259 260 0 5 19 -12 43 -38 23 -25 84 -81 135 -124z m1467 67 c3 -36 3 -102 -2 -148 l-8 -83 -6 75 c-10 116 -10 232 0 226 5 -3 12 -35 16 -70z m-172 -84 c-2 -35 -8 -83 -13 -105 -8 -41 -8 -41 -9 19 -1 88 11 193 19 169 4 -11 6 -49 3 -83z m446 34 c10 -43 16 -184 7 -175 -3 3 -10 45 -16 94 -6 50 -14 101 -17 114 -4 15 -2 22 4 18 6 -4 16 -27 22 -51z m4260 -1722 c27 -63 90 -123 156 -151 25 -10 45 -20 45 -23 0 -3 -25 -16 -56 -29 -63 -27 -123 -90 -151 -156 -10 -25 -20 -45 -23 -45 -3 0 -16 25 -29 56 -27 63 -90 123 -156 151 -25 10 -45 20 -45 23 0 3 25 16 56 29 63 27 123 90 151 156 10 25 20 45 23 45 3 0 16 -25 29 -56z"/>
                   </g>
                 )}
             </motion.g>

             {currentPoints.map((point) => {
               const isSelected = visualSelectionId === point.id;
               return (
                 <g key={point.id} onClick={() => handlePointClick(point)} className="cursor-pointer group">
                   <circle cx={point.x} cy={point.y} r="6" fill="transparent" />
                   <g transform={`translate(${point.x}, ${point.y})`}>
                      <JewelryRenderer point={point} isSelected={isSelected} />
                   </g>
                   <g className={`opacity-0 group-hover:opacity-100 transition-opacity duration-300 ${isSelected ? 'opacity-100' : ''}`}>
                       <text 
                        x={point.x} 
                        y={point.y + 10} 
                        fontSize="3" 
                        fill="white"
                        textAnchor="middle"
                        className="font-sans pointer-events-none drop-shadow-md"
                        style={{ textShadow: '0 2px 4px rgba(0,0,0,0.8)' }}
                        >
                        {point.label}
                        </text>
                   </g>
                 </g>
               );
             })}
           </svg>
           
           <AnimatePresence>
             {hoverMessage && (
               <motion.div
                 initial={{ opacity: 0, y: 5 }}
                 animate={{ opacity: 1, y: 0 }}
                 exit={{ opacity: 0, y: 5 }}
                 className="absolute z-20 bg-brand-surface border border-white/10 text-slate-200 text-xs px-4 py-2 rounded-xl shadow-xl backdrop-blur-md whitespace-nowrap pointer-events-none flex items-center gap-2"
                 style={{ 
                   left: `${hoverMessage.x}%`, 
                   top: `${hoverMessage.y - 12}%`,
                   transform: 'translate(-50%, -100%)' 
                 }}
               >
                 <AlertCircle className="w-3 h-3 text-brand-primary" />
                 {hoverMessage.text}
                 <div className="absolute bottom-[-5px] left-1/2 -translate-x-1/2 w-2.5 h-2.5 bg-brand-surface border-b border-r border-white/10 rotate-45"></div>
               </motion.div>
             )}
           </AnimatePresence>
        </div>
      </div>

      <div className="order-1 md:order-2 h-full">
        <h3 className="text-2xl font-serif text-white mb-6 border-r-2 border-brand-primary pr-4">
           {selectedService ? 'הבחירה שלך' : 'בחר אזור לניקוב'}
        </h3>
        
        <AnimatePresence mode="wait">
          {selectedService ? (
            <motion.div
              key="selected"
              initial={{ opacity: 0, x: 20 }}
              animate={{ opacity: 1, x: 0 }}
              exit={{ opacity: 0, x: -20 }}
            >
              <Card className="bg-brand-surface border-brand-primary/30 relative overflow-hidden group">
                 <div className="absolute top-0 right-0 w-32 h-32 bg-brand-primary/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                 
                 <div className="relative z-10">
                   <div className="flex justify-between items-start mb-4">
                     <h2 className="text-3xl font-medium text-white">{selectedService.name}</h2>
                     <div className="text-3xl font-serif text-brand-primary">₪{selectedService.price}</div>
                   </div>
                   
                   <div className="space-y-4 mb-8">
                      <div className="flex items-center gap-3 text-slate-400">
                        <Clock className="w-4 h-4 text-brand-primary" />
                        <span>משך טיפול: <span className="text-white">{selectedService.duration_minutes} דקות</span></span>
                      </div>
                      <div className="flex items-center gap-3 text-slate-400">
                        <Sparkles className="w-4 h-4 text-brand-primary" />
                        <span>רמת כאב: <span className="text-white">●●○○○ (קל)</span></span>
                      </div>
                      <p className="text-slate-400 text-sm leading-relaxed border-t border-white/5 pt-4">
                        {selectedService.description}
                      </p>
                   </div>
                   
                   <div className="flex gap-3">
                     <button onClick={() => { onSelect(null as any); setVisualSelectionId(null); }} className="text-sm text-slate-500 hover:text-white underline">
                        בחר שירות אחר
                     </button>
                   </div>
                 </div>
              </Card>
            </motion.div>
          ) : (
             <motion.div
              key="list"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              className="space-y-3 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar"
             >
                <p className="text-slate-500 text-sm mb-4">
                   לחץ על האזורים במפה או בחר מהרשימה המלאה:
                </p>
                {services.filter(s => view === 'ear' ? s.category === 'Ear' : s.category !== 'Ear').map((service) => (
                   <div 
                      key={service.id}
                      onClick={() => {
                          const point = [...earPoints, ...facePoints].find(p => service.name.includes(p.keyword));
                          if (point) setVisualSelectionId(point.id);
                          onSelect(service);
                      }}
                      className="flex items-center justify-between p-4 rounded-xl border border-white/5 bg-white/[0.02] hover:bg-white/5 hover:border-brand-primary/20 cursor-pointer transition-all group"
                   >
                      <div className="flex items-center gap-4">
                         <div className="w-10 h-10 rounded-lg bg-brand-dark overflow-hidden">
                            <img src={service.image_url} alt="" className="w-full h-full object-cover opacity-70 group-hover:opacity-100" />
                         </div>
                         <div>
                            <div className="text-white font-medium text-sm group-hover:text-brand-primary transition-colors">{service.name}</div>
                            <div className="text-xs text-slate-500">{service.duration_minutes} דק'</div>
                         </div>
                      </div>
                      <div className="text-brand-primary/70 font-serif">₪{service.price}</div>
                   </div>
                ))}
             </motion.div>
          )}
        </AnimatePresence>
      </div>
    </div>
  );
};

const Booking: React.FC = () => {
  const [step, setStep] = useState<BookingStep>(BookingStep.SELECT_SERVICE);
  const [services, setServices] = useState<Service[]>([]);
  const [selectedService, setSelectedService] = useState<Service | null>(null);
  
  // Step 2: Date & Time
  const [selectedDate, setSelectedDate] = useState<Date | null>(null);
  const [availableSlots, setAvailableSlots] = useState<TimeSlot[]>([]);
  const [selectedSlot, setSelectedSlot] = useState<string | null>(null);
  const [isLoadingSlots, setIsLoadingSlots] = useState(false);
  
  // Step 3: Details
  const [formData, setFormData] = useState({
      name: '',
      phone: '',
      email: '',
      notes: ''
  });
  const [isSubmitting, setIsSubmitting] = useState(false);

  useEffect(() => {
    api.getServices().then(setServices);
  }, []);

  useEffect(() => {
      if (selectedDate) {
          setIsLoadingSlots(true);
          api.getAvailability(selectedDate).then((slots) => {
              setAvailableSlots(slots);
              setIsLoadingSlots(false);
          });
      }
  }, [selectedDate]);

  const generateCalendarDays = () => {
      const today = new Date();
      const days = [];
      for(let i = 0; i < 14; i++) {
          const d = new Date(today);
          d.setDate(today.getDate() + i);
          days.push(d);
      }
      return days;
  };

  const handleBook = async () => {
      if(!selectedService || !selectedDate || !selectedSlot) return;
      
      setIsSubmitting(true);
      
      const [hours, minutes] = selectedSlot.split(':').map(Number);
      const date = new Date(selectedDate);
      date.setHours(hours, minutes);

      try {
        await api.createAppointment({
            service_id: selectedService.id,
            start_time: date.toISOString(),
            client_name: formData.name,
            client_phone: formData.phone,
            client_email: formData.email,
            notes: formData.notes
        });
        setStep(BookingStep.CONFIRMATION);
      } catch (err) {
          console.error(err);
      } finally {
          setIsSubmitting(false);
      }
  };

  return (
    <div className="min-h-screen bg-brand-dark pt-24 pb-12">
        <div className="container mx-auto px-6">
            {/* Header / Progress */}
            <div className="mb-8 flex justify-between items-end">
                <div>
                    <h1 className="text-3xl font-serif text-white mb-2">קביעת תור</h1>
                    <p className="text-slate-400 text-sm">שלב {step} מתוך 4</p>
                </div>
                {step > 1 && step < 4 && (
                    <button 
                        onClick={() => setStep(step - 1)} 
                        className="text-slate-400 hover:text-white flex items-center gap-2 text-sm"
                    >
                        <ArrowRight className="w-4 h-4" /> חזרה
                    </button>
                )}
            </div>

            {/* Steps */}
            <AnimatePresence mode="wait">
                {step === BookingStep.SELECT_SERVICE && (
                    <motion.div
                        key="step1"
                        initial={{ opacity: 0, x: 20 }}
                        animate={{ opacity: 1, x: 0 }}
                        exit={{ opacity: 0, x: -20 }}
                    >
                        <AnatomyMap 
                            services={services} 
                            selectedService={selectedService} 
                            onSelect={setSelectedService} 
                        />
                        <div className="flex justify-center mt-8">
                            <Button 
                                disabled={!selectedService} 
                                onClick={() => setStep(BookingStep.SELECT_DATE)}
                                className="w-full md:w-auto min-w-[200px]"
                            >
                                המשך לבחירת תאריך
                            </Button>
                        </div>
                    </motion.div>
                )}

                {step === BookingStep.SELECT_DATE && (
                    <motion.div
                        key="step2"
                        initial={{ opacity: 0, x: 20 }}
                        animate={{ opacity: 1, x: 0 }}
                        exit={{ opacity: 0, x: -20 }}
                        className="max-w-4xl mx-auto"
                    >
                        <Card className="mb-8">
                            <h3 className="text-white font-medium mb-4 flex items-center gap-2"><Calendar className="w-5 h-5 text-brand-primary"/> בחר תאריך</h3>
                            <div className="flex gap-4 overflow-x-auto pb-4 custom-scrollbar">
                                {generateCalendarDays().map((date, i) => {
                                    const isSelected = selectedDate?.toDateString() === date.toDateString();
                                    return (
                                        <button
                                            key={i}
                                            onClick={() => { setSelectedDate(date); setSelectedSlot(null); }}
                                            className={`flex flex-col items-center justify-center min-w-[80px] h-24 rounded-xl border transition-all ${
                                                isSelected 
                                                ? 'bg-brand-primary text-brand-dark border-brand-primary' 
                                                : 'bg-white/5 border-white/10 text-slate-400 hover:border-brand-primary/50 hover:text-white'
                                            }`}
                                        >
                                            <span className="text-xs">{date.toLocaleDateString('he-IL', { weekday: 'short' })}</span>
                                            <span className="text-2xl font-bold font-serif">{date.getDate()}</span>
                                            <span className="text-xs">{date.toLocaleDateString('he-IL', { month: 'short' })}</span>
                                        </button>
                                    )
                                })}
                            </div>
                        </Card>

                        {selectedDate && (
                            <Card>
                                <h3 className="text-white font-medium mb-4 flex items-center gap-2"><Clock className="w-5 h-5 text-brand-primary"/> בחר שעה</h3>
                                {isLoadingSlots ? (
                                    <div className="py-12 flex justify-center text-brand-primary">
                                        <Loader2 className="w-8 h-8 animate-spin" />
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3">
                                        {availableSlots.length > 0 ? availableSlots.map((slot, i) => (
                                            <button
                                                key={i}
                                                disabled={!slot.available}
                                                onClick={() => setSelectedSlot(slot.time)}
                                                className={`py-2 rounded-lg text-sm border transition-all ${
                                                    selectedSlot === slot.time
                                                    ? 'bg-brand-primary text-brand-dark border-brand-primary font-bold'
                                                    : slot.available
                                                        ? 'bg-white/5 border-white/10 text-white hover:border-brand-primary/50'
                                                        : 'bg-transparent border-transparent text-slate-600 cursor-not-allowed line-through'
                                                }`}
                                            >
                                                {slot.time}
                                            </button>
                                        )) : (
                                            <div className="col-span-full text-center text-slate-500 py-8">
                                                אין תורים פנויים לתאריך זה. נסה תאריך אחר.
                                            </div>
                                        )}
                                    </div>
                                )}
                            </Card>
                        )}

                        <div className="flex justify-center mt-8">
                            <Button 
                                disabled={!selectedDate || !selectedSlot} 
                                onClick={() => setStep(BookingStep.DETAILS)}
                                className="w-full md:w-auto min-w-[200px]"
                            >
                                המשך למילוי פרטים
                            </Button>
                        </div>
                    </motion.div>
                )}

                {step === BookingStep.DETAILS && (
                    <motion.div
                        key="step3"
                        initial={{ opacity: 0, x: 20 }}
                        animate={{ opacity: 1, x: 0 }}
                        exit={{ opacity: 0, x: -20 }}
                        className="max-w-2xl mx-auto"
                    >
                        <Card>
                            <h3 className="text-white font-medium mb-6">פרטים אישיים</h3>
                            <div className="space-y-4">
                                <Input 
                                    label="שם מלא" 
                                    value={formData.name}
                                    onChange={e => setFormData({...formData, name: e.target.value})}
                                />
                                <Input 
                                    label="טלפון נייד" 
                                    type="tel"
                                    value={formData.phone}
                                    onChange={e => setFormData({...formData, phone: e.target.value})}
                                />
                                <Input 
                                    label="אימייל" 
                                    type="email"
                                    value={formData.email}
                                    onChange={e => setFormData({...formData, email: e.target.value})}
                                />
                                <div className="flex flex-col gap-2">
                                    <label className="text-sm font-medium text-slate-400 ms-1">הערות נוספות</label>
                                    <textarea 
                                        className="bg-brand-dark/50 border border-brand-border focus:border-brand-primary/50 text-white px-5 py-3 rounded-xl outline-none transition-all placeholder:text-slate-600 min-h-[100px]"
                                        value={formData.notes}
                                        onChange={e => setFormData({...formData, notes: e.target.value})}
                                    />
                                </div>
                            </div>

                            <div className="mt-8 pt-6 border-t border-white/10">
                                <div className="flex justify-between items-center mb-2 text-sm text-slate-400">
                                    <span>שירות נבחר:</span>
                                    <span className="text-white font-medium">{selectedService?.name}</span>
                                </div>
                                <div className="flex justify-between items-center mb-2 text-sm text-slate-400">
                                    <span>מועד:</span>
                                    <span className="text-white font-medium">
                                        {selectedDate?.toLocaleDateString('he-IL')} בשעה {selectedSlot}
                                    </span>
                                </div>
                                <div className="flex justify-between items-center mt-4 text-xl text-white font-serif">
                                    <span>סה"כ לתשלום:</span>
                                    <span className="text-brand-primary">₪{selectedService?.price}</span>
                                </div>
                            </div>
                        </Card>

                        <div className="flex justify-center mt-8">
                            <Button 
                                disabled={!formData.name || !formData.phone || isSubmitting} 
                                onClick={handleBook}
                                isLoading={isSubmitting}
                                className="w-full md:w-auto min-w-[200px]"
                            >
                                אשר וקבע תור
                            </Button>
                        </div>
                    </motion.div>
                )}

                {step === BookingStep.CONFIRMATION && (
                    <motion.div
                        key="step4"
                        initial={{ opacity: 0, scale: 0.9 }}
                        animate={{ opacity: 1, scale: 1 }}
                        className="max-w-md mx-auto text-center"
                    >
                        <div className="w-24 h-24 bg-emerald-500/10 rounded-full flex items-center justify-center mx-auto mb-6 text-emerald-500">
                            <Sparkles className="w-12 h-12" />
                        </div>
                        <h2 className="text-3xl font-serif text-white mb-4">התור נקבע בהצלחה!</h2>
                        <p className="text-slate-400 mb-8">
                            תודה {formData.name}, קבענו לך תור ל{selectedService?.name} בתאריך {selectedDate?.toLocaleDateString('he-IL')} בשעה {selectedSlot}.
                            <br/>
                            נשלח לך פרטים נוספים לנייד.
                        </p>
                        <Button onClick={() => window.location.href = '/'}>
                            חזרה לדף הבית
                        </Button>
                    </motion.div>
                )}
            </AnimatePresence>
        </div>
    </div>
  );
};

export default Booking;